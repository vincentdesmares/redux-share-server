!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("body-parser"),require("express"),require("ws")):"function"==typeof define&&define.amd?define(["body-parser","express","ws"],t):"object"==typeof exports?exports.ReduxShareServer=t(require("body-parser"),require("express"),require("ws")):e.ReduxShareServer=t(e["body-parser"],e.express,e.ws)}(this,function(e,t,n){return function(e){function t(o){if(n[o])return n[o].exports;var i=n[o]={exports:{},id:o,loaded:!1};return e[o].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var n={};return t.m=e,t.c=n,t.p="/dist/",t(0)}([function(e,t,n){"use strict";function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,n,o){return n&&e(t.prototype,n),o&&e(t,o),t}}(),r=n(1),s=n(3).Server,u=n(2),c=function(){function e(t,n){var i=this;o(this,e),this.wss=new s({server:t}),this.store=null;var r={debug:!1,onConnection:function(e){return e.id=i.socketNumber++,e},onActionReceived:function(e,t){return e.origin=t.id,e},shouldDispatch:function(e){return"@@SYNC-CONNECT-SERVER-SUCCESS"!==e.type},shouldSend:function(){return!0},repeaterMode:!1};this.options=Object.assign({},r,n),this.readyToServe=!1,this.socketNumber=0}return i(e,[{key:"getExpressMiddleware",value:function(){var e=u.Router();return e.use(r.urlencoded({extended:!1})),e.use(r.json()),e.post("/action",function(e,t){var n=e.body;if(this.log("Dispatching an action to the store",n),this.store)this.store.dispatch(n),t.send(JSON.stringify({success:!0}));else{var o="Not ready yet, did you attach the redux middleware and dispatch the action @@SERVER-LISTEN-START?";this.log(o),t.send(JSON.stringify({success:!1,message:o}))}t.end()}.bind(this)),e.get("/state",function(e,t){t.send(JSON.stringify(this.store.getState(),null,4)),t.end()}.bind(this)),e}},{key:"getReduxMiddleware",value:function(){var e=this;return function(t){return function(n){return function(o){if(e.log('Action "'+o.type+'" received by the redux middleware'),null===e.store&&(e.store=t),e.options.shouldDispatch.apply(e,[o])){e.log("We dispatch this action ");var i=n(o)}else{e.log("We dont dispatch this action ");var i=null}return void 0!==o.origin&&"server"!==o.origin||e.options.repeaterMode&&e.broadcastAction(o),"@@SERVER-LISTEN-START"===o.type&&e._startListen(),i}}}}},{key:"findSockets",value:function(e,t){return this.wss.clients.filter(function(n){return void 0!==n[e]&&n[e]===t})}},{key:"broadcastAction",value:function(e){var t=arguments.length<=1||void 0===arguments[1]?null:arguments[1];return this.log("Dispatches an action to all clients",e),"function"!=typeof t&&(t=function(){return!0}),this.wss.clients.filter(t).map(function(t){return this.sendToAction(e,t)}.bind(this))}},{key:"sendToAction",value:function(e,t){var n=Object.assign({},e,{origin:"server"});return this.options.shouldSend.apply(this,[n,t])?(this.log("Send to client ",t.id," ",n),t.send(JSON.stringify(n))):void this.log("Do not send to client ",t.id," ",n)}},{key:"log",value:function(){if(this.options.debug){var e;(e=console).log.apply(e,["redux-share-server: "].concat(Array.prototype.slice.call(arguments)))}}},{key:"_startListen",value:function(){this.wss.on("connection",function(e){"function"==typeof this.options.onConnection&&(e=this.options.onConnection(e)||e),e.on("message",function(t){this.log("Received from client the message ",t);var n=JSON.parse(t);"function"==typeof this.options.onActionReceived&&(n=this.options.onActionReceived.apply(this,[n,e])),this.log("Dispatching the action to the store",n),this.store?this.store.dispatch(n):this.log("Store not ready yet, did you forget to add the redux middleware?"),this.options.repeaterMode&&this.broadcastAction(n,function(t){return t!==e})}.bind(this))}.bind(this)),this.readyToServe=!0}}]),e}();e.exports=c},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("ws")}])});
//# sourceMappingURL=server.bundle.js.map